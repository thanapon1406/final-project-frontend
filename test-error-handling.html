<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทดสอบการจัดการข้อผิดพลาด - ห้วยตึงเฒ่า</title>
    <!-- Bootstrap 5.1.3 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 5.10.0 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css">
    <!-- Itim Font -->
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .test-title {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .image-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .image-test-item {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            text-align: center;
        }
        .image-test-item img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <header class="text-center py-4 bg-primary text-white">
                    <h1><i class="fas fa-bug"></i> ทดสอบการจัดการข้อผิดพลาดและรูปภาพ</h1>
                    <p>หน้านี้ใช้สำหรับทดสอบระบบจัดการข้อผิดพลาดและการแสดงรูปภาพสำรอง</p>
                </header>
            </div>
        </div>

        <div class="container my-4">
            <!-- Error Summary Section -->
            <div class="test-section">
                <h2 class="test-title"><i class="fas fa-exclamation-triangle"></i> สรุปข้อผิดพลาด</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div id="errorSummary" class="error-log">
                            <div class="text-muted">กำลังโหลดข้อมูลข้อผิดพลาด...</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>การทดสอบ</h5>
                        <button class="btn btn-danger btn-sm me-2" onclick="testJavaScriptError()">
                            <i class="fas fa-code"></i> ทดสอบ JS Error
                        </button>
                        <button class="btn btn-warning btn-sm me-2" onclick="testConsoleWarning()">
                            <i class="fas fa-exclamation"></i> ทดสอบ Warning
                        </button>
                        <button class="btn btn-info btn-sm me-2" onclick="testPromiseRejection()">
                            <i class="fas fa-times-circle"></i> ทดสอบ Promise Rejection
                        </button>
                        <button class="btn btn-success btn-sm" onclick="clearErrorLog()">
                            <i class="fas fa-trash"></i> ล้างข้อผิดพลาด
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Fallback Testing Section -->
            <div class="test-section">
                <h2 class="test-title"><i class="fas fa-images"></i> ทดสอบรูปภาพสำรอง</h2>
                <p>รูปภาพด้านล่างจะแสดงระบบสำรองเมื่อไม่สามารถโหลดรูปภาพได้</p>
                
                <div class="image-test-grid">
                    <!-- Valid Image -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-success"></span>รูปภาพปกติ</h6>
                        <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80" 
                             alt="รูปภาพปกติ" class="gallery-image">
                        <small class="text-muted d-block mt-2">รูปภาพที่โหลดได้ปกติ</small>
                    </div>

                    <!-- Broken Image URL -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-error"></span>URL ผิด</h6>
                        <img src="https://invalid-url-that-does-not-exist.com/image.jpg" 
                             alt="รูปภาพ URL ผิด" class="gallery-image">
                        <small class="text-muted d-block mt-2">URL ที่ไม่มีอยู่จริง</small>
                    </div>

                    <!-- Missing src attribute -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-warning"></span>ไม่มี src</h6>
                        <img alt="รูปภาพไม่มี src" class="gallery-image">
                        <small class="text-muted d-block mt-2">ไม่มี src attribute</small>
                    </div>

                    <!-- Carousel type fallback -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-error"></span>Carousel</h6>
                        <img src="https://broken-carousel-image.com/slide.jpg" 
                             alt="สไลด์" class="carousel-image">
                        <small class="text-muted d-block mt-2">รูปภาพสำรองแบบ Carousel</small>
                    </div>

                    <!-- Featured type fallback -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-error"></span>Featured</h6>
                        <img src="https://broken-featured-image.com/featured.jpg" 
                             alt="เนื้อหาเด่น" class="featured-image">
                        <small class="text-muted d-block mt-2">รูปภาพสำรองแบบ Featured</small>
                    </div>

                    <!-- History type fallback -->
                    <div class="image-test-item">
                        <h6><span class="status-indicator status-error"></span>History</h6>
                        <img src="https://broken-history-image.com/history.jpg" 
                             alt="ประวัติ" class="history-image">
                        <small class="text-muted d-block mt-2">รูปภาพสำรองแบบ History</small>
                    </div>
                </div>
            </div>

            <!-- Dynamic Content Testing -->
            <div class="test-section">
                <h2 class="test-title"><i class="fas fa-sync-alt"></i> ทดสอบเนื้อหาแบบไดนามิก</h2>
                <p>ทดสอบการโหลดเนื้อหาจาก JSON และการจัดการข้อผิดพลาด</p>
                
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 mb-2" onclick="testValidJSON()">
                            <i class="fas fa-check"></i> โหลด JSON ปกติ
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100 mb-2" onclick="testInvalidJSON()">
                            <i class="fas fa-exclamation"></i> โหลด JSON ผิด
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-danger w-100 mb-2" onclick="testMissingJSON()">
                            <i class="fas fa-times"></i> โหลด JSON ที่ไม่มี
                        </button>
                    </div>
                </div>

                <div id="dynamicContent" class="mt-3 p-3 bg-light border rounded">
                    <div class="text-muted">คลิกปุ่มด้านบนเพื่อทดสอบการโหลดเนื้อหา</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="test-section">
                <h2 class="test-title"><i class="fas fa-tachometer-alt"></i> ข้อมูลประสิทธิภาพ</h2>
                <div id="performanceMetrics" class="error-log">
                    <div class="text-muted">กำลังโหลดข้อมูลประสิทธิภาพ...</div>
                </div>
            </div>

            <!-- Console Output -->
            <div class="test-section">
                <h2 class="test-title"><i class="fas fa-terminal"></i> Console Output</h2>
                <div id="consoleOutput" class="error-log">
                    <div class="text-muted">Console messages จะแสดงที่นี่...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Error Handler (Load First) -->
    <script src="js/error-handler.js"></script>
    <!-- Performance Optimizer -->
    <script src="js/performance-optimizer.js"></script>

    <script>
        // Test functions
        function testJavaScriptError() {
            try {
                // Intentionally cause an error
                undefinedFunction();
            } catch (error) {
                console.error('Test JavaScript Error:', error.message);
            }
        }

        function testConsoleWarning() {
            console.warn('This is a test warning message');
        }

        function testPromiseRejection() {
            Promise.reject('Test promise rejection').catch(() => {
                // This will be caught by the unhandled rejection handler
            });
            
            // Also create an unhandled rejection
            new Promise((resolve, reject) => {
                setTimeout(() => reject('Unhandled test rejection'), 100);
            });
        }

        function testValidJSON() {
            $.getJSON('data/homepage-gallery.json')
                .done(function(data) {
                    $('#dynamicContent').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check"></i> โหลด JSON สำเร็จ
                            <pre class="mt-2 mb-0">${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                        </div>
                    `);
                })
                .fail(function() {
                    $('#dynamicContent').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-times"></i> ไม่สามารถโหลด JSON ได้
                        </div>
                    `);
                });
        }

        function testInvalidJSON() {
            // Try to load a file that contains invalid JSON
            $.ajax({
                url: 'index.html', // This is HTML, not JSON
                dataType: 'json'
            })
            .done(function(data) {
                $('#dynamicContent').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check"></i> โหลดสำเร็จ (ไม่คาดคิด)
                    </div>
                `);
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                $('#dynamicContent').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation"></i> JSON ไม่ถูกต้อง: ${textStatus} - ${errorThrown}
                    </div>
                `);
            });
        }

        function testMissingJSON() {
            $.getJSON('data/non-existent-file.json')
                .done(function(data) {
                    $('#dynamicContent').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check"></i> โหลดสำเร็จ (ไม่คาดคิด)
                        </div>
                    `);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    $('#dynamicContent').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-times"></i> ไม่พบไฟล์: ${textStatus} - ${errorThrown}
                        </div>
                    `);
                });
        }

        function clearErrorLog() {
            if (window.errorHandler) {
                window.errorHandler.clearErrors();
                updateErrorSummary();
            }
        }

        function updateErrorSummary() {
            if (window.errorHandler) {
                const summary = window.errorHandler.getErrorSummary();
                const summaryHTML = `
                    <div><strong>ข้อผิดพลาดทั้งหมด:</strong> ${summary.total}</div>
                    <div class="mt-2"><strong>แยกตามประเภท:</strong></div>
                    ${Object.entries(summary.byType).map(([type, count]) => 
                        `<div>• ${type}: ${count}</div>`
                    ).join('')}
                    <div class="mt-2"><strong>แยกตามระดับ:</strong></div>
                    ${Object.entries(summary.byLevel).map(([level, count]) => 
                        `<div>• ${level}: ${count}</div>`
                    ).join('')}
                    ${summary.recent.length > 0 ? `
                        <div class="mt-2"><strong>ข้อผิดพลาดล่าสุด:</strong></div>
                        ${summary.recent.slice(-3).map(error => 
                            `<div class="small text-muted">• ${error.type}: ${error.details.message || JSON.stringify(error.details).substring(0, 50)}...</div>`
                        ).join('')}
                    ` : ''}
                `;
                $('#errorSummary').html(summaryHTML);
            }
        }

        function updatePerformanceMetrics() {
            if (window.performanceOptimizer) {
                const report = window.performanceOptimizer.generatePerformanceReport();
                const metricsHTML = `
                    <div><strong>Performance Score:</strong> ${report.score}/100</div>
                    <div class="mt-2"><strong>Optimizations Applied:</strong></div>
                    ${report.optimizations.map(opt => 
                        `<div class="small">• ${opt.type}: ${opt.message}</div>`
                    ).join('')}
                    ${report.metrics.pageLoad ? `
                        <div class="mt-2"><strong>Page Load Metrics:</strong></div>
                        ${Object.entries(report.metrics.pageLoad).map(([metric, value]) => 
                            `<div class="small">• ${metric}: ${value}ms</div>`
                        ).join('')}
                    ` : ''}
                `;
                $('#performanceMetrics').html(metricsHTML);
            }
        }

        // Override console methods to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsoleOutput(type, message, color) {
            const timestamp = new Date().toLocaleTimeString();
            const outputDiv = $('#consoleOutput');
            const newMessage = `<div style="color: ${color};">[${timestamp}] ${type}: ${message}</div>`;
            outputDiv.append(newMessage);
            outputDiv.scrollTop(outputDiv[0].scrollHeight);
        }

        console.log = function(...args) {
            addToConsoleOutput('LOG', args.join(' '), '#333');
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            addToConsoleOutput('ERROR', args.join(' '), '#dc3545');
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            addToConsoleOutput('WARN', args.join(' '), '#ffc107');
            originalWarn.apply(console, args);
        };

        // Initialize page
        $(document).ready(function() {
            console.log('Error handling test page loaded');
            
            // Update summaries periodically
            setInterval(updateErrorSummary, 2000);
            
            // Update performance metrics after page load
            setTimeout(updatePerformanceMetrics, 3000);
            
            // Initial updates
            setTimeout(updateErrorSummary, 1000);
        });
    </script>
</body>
</html>