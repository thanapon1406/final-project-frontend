<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Editor - ห้วยตึงเฒ่า Admin</title>
    <!-- Bootstrap 5.1.3 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Preload Resources -->
    <link
      rel="preload"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/webfonts/fa-solid-900.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/webfonts/fa-regular-400.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Font Awesome 5.10.0 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
    />
    <!-- Thai Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/admin.css" />
    <style>
      /* JSON Editor Specific Styles - Lean Version */

      /* JSON File Cards */
      .json-file-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        box-shadow: var(--shadow-sm);
      }

      .json-file-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
      }

      .json-file-card .card-body {
        padding: 1.5rem;
      }
      .json-file-card .fa-3x {
        margin-bottom: 1rem;
      }

      /* Save Button */
      .btn-save {
        background: linear-gradient(
          45deg,
          var(--success-color),
          var(--accent-color)
        );
        border: none;
        color: var(--text-light);
        transition: all 0.3s ease;
      }

      .btn-save:hover {
        background: linear-gradient(45deg, #229954, #2980b9);
        color: var(--text-light);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      /* Mobile Optimizations */
      @media (max-width: 768px) {
        .json-file-card {
          min-height: 140px;
        }
        .json-file-card .fa-3x {
          font-size: 2rem !important;
        }
        .json-file-card h5 {
          font-size: 0.95rem;
          margin-bottom: 0.5rem;
        }
        .json-file-card .card-text {
          font-size: 0.8rem;
          margin-bottom: 0.5rem;
        }
        .json-file-card small {
          font-size: 0.75rem;
        }

        /* Form Layout */
        .card-header .d-flex {
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
        }

        /* Alert Layout */
        .alert .d-flex {
          flex-direction: column;
          text-align: center;
        }

        .alert .d-flex .fas {
          margin-bottom: 0.5rem;
          margin-right: 0 !important;
        }
      }

      @media (max-width: 576px) {
        .row.mb-4 > .col-lg-4 {
          padding-left: 0.5rem;
          padding-right: 0.5rem;
        }

        .json-file-card {
          margin-bottom: 0.75rem;
        }

        /* Stack action buttons */
        .mt-4.text-center .btn {
          display: block;
          width: 100%;
          margin: 0.25rem 0;
        }

        .mt-4.text-center .btn:first-child {
          margin-top: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile Navigation Toggle -->
    <button class="mobile-nav-toggle d-md-none" onclick="toggleMobileNav()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" onclick="closeMobileNav()"></div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav
          class="col-md-3 col-lg-2 d-md-block admin-sidebar collapse"
          id="adminSidebar"
        >
          <div class="position-sticky pt-3">
            <div class="text-center mb-4">
              <img
                src="https://huaytuengthao.com/image/LOGO_.png"
                alt="Logo"
                class="img-fluid mb-2"
                style="max-width: 80px"
                onerror="this.style.display='none'"
              />
              <h5 class="text-white">ห้วยตึงเฒ่า Admin</h5>
              <small class="text-white-50">ระบบจัดการเนื้อหา</small>
            </div>

            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="json-editor.html">
                  <i class="fas fa-code me-2"></i>
                  แก้ไข JSON
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../index.html" target="_blank">
                  <i class="fas fa-external-link-alt me-2"></i>
                  ดูเว็บไซต์
                </a>
              </li>
              <li class="nav-item mt-auto">
                <hr class="text-white-50" />
                <a class="nav-link text-danger" href="#" onclick="logout()">
                  <i class="fas fa-sign-out-alt me-2"></i>
                  ออกจากระบบ
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main
          class="col-md-9 ms-sm-auto col-lg-10 px-md-4 admin-content"
          style="padding-top: 4rem"
        >
          <!-- Mobile header spacer -->
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2"><i class="fas fa-code me-2"></i>แก้ไขไฟล์ JSON</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group me-2">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  onclick="refreshJsonList()"
                >
                  <i class="fas fa-sync-alt me-1"></i>รีเฟรช
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-info"
                  onclick="testJsonLoad()"
                >
                  <i class="fas fa-bug me-1"></i>ทดสอบ
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-warning"
                  onclick="viewBackups()"
                >
                  <i class="fas fa-history me-1"></i>Backup
                </button>
              </div>
            </div>
          </div>

          <!-- Alert area -->
          <div id="alertArea"></div>

          <!-- API Status -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="card border-info">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="me-3">
                      <i
                        id="apiStatusIcon"
                        class="fas fa-circle text-secondary"
                      ></i>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1">สถานะ API Server</h6>
                      <small id="apiStatusText" class="text-muted"
                        >กำลังตรวจสอบ...</small
                      >
                    </div>
                    <div>
                      <button
                        class="btn btn-sm btn-outline-info"
                        onclick="checkApiStatus()"
                      >
                        <i class="fas fa-sync-alt me-1"></i>ตรวจสอบ
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- JSON File Selection -->
          <div class="row mb-4" id="jsonFileList">
            <div class="col-12">
              <h4 class="mb-3">เลือกไฟล์ JSON ที่ต้องการแก้ไข</h4>
              <div class="alert alert-info">
                <div class="d-flex align-items-center">
                  <i class="fas fa-info-circle me-2"></i>
                  <div>
                    <strong>ระบบใหม่!</strong> ตอนนี้สามารถบันทึกไฟล์โดยตรงผ่าน
                    API แล้ว ไม่จำเป็นต้องดาวน์โหลดและแทนที่ไฟล์เอง <br /><small
                      class="text-muted"
                      >หาก API ไม่พร้อมใช้งาน ระบบจะใช้โหมด Fallback
                      อัตโนมัติ</small
                    >
                  </div>
                </div>
              </div>

              <div class="alert alert-success">
                <div class="d-flex align-items-center">
                  <i class="fas fa-star me-2"></i>
                  <div>
                    <strong>หน้าประวัติใหม่!</strong>
                    ตอนนี้สามารถจัดการรูปภาพในหน้าประวัติได้แล้ว
                    รองรับการจัดวางรูปภาพแบบต่างๆ (ซ้าย, ขวา, กลาง, เต็มหน้า)
                    พร้อมคำบรรยายภาพ <br /><small class="text-muted">
                      รูปภาพจะแสดงผลแบบ responsive และมี hover effects ที่สวยงาม
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Homepage JSON Files -->
            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('homepage-carousel')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-images fa-3x text-primary mb-3"></i>
                  <h5 class="card-title">Carousel หน้าหลัก</h5>
                  <p class="card-text text-muted">จัดการสไลด์รูปภาพหน้าหลัก</p>
                  <small class="text-info">homepage-carousel.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('homepage-news')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-newspaper fa-3x text-success mb-3"></i>
                  <h5 class="card-title">ข่าวสารหน้าหลัก</h5>
                  <p class="card-text text-muted">จัดการประกาศและข่าวสาร</p>
                  <small class="text-info">homepage-news.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('homepage-featured')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-star fa-3x text-warning mb-3"></i>
                  <h5 class="card-title">เนื้อหาเด่นหน้าหลัก</h5>
                  <p class="card-text text-muted">จัดการเนื้อหาที่น่าสนใจ</p>
                  <small class="text-info">homepage-featured.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('homepage-gallery')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-photo-video fa-3x text-info mb-3"></i>
                  <h5 class="card-title">แกลเลอรี่หน้าหลัก</h5>
                  <p class="card-text text-muted">จัดการรูปภาพในแกลเลอรี่</p>
                  <small class="text-info">homepage-gallery.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('homepage-services')"
              >
                <div class="card-body text-center">
                  <i
                    class="fas fa-concierge-bell fa-3x text-secondary mb-3"
                  ></i>
                  <h5 class="card-title">บริการหน้าหลัก</h5>
                  <p class="card-text text-muted">จัดการข้อมูลบริการ</p>
                  <small class="text-info">homepage-services.json</small>
                </div>
              </div>
            </div>

            <!-- Page JSON Files -->
            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('page-services')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-tools fa-3x text-primary mb-3"></i>
                  <h5 class="card-title">หน้าบริการ</h5>
                  <p class="card-text text-muted">จัดการเนื้อหาหน้าบริการ</p>
                  <small class="text-info">page-services.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('page-history')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-history fa-3x text-success mb-3"></i>
                  <h5 class="card-title">หน้าประวัติ</h5>
                  <p class="card-text text-muted">
                    จัดการเนื้อหาประวัติและรูปภาพ
                  </p>
                  <small class="text-info">page-history.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('contact-content')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-address-book fa-3x text-warning mb-3"></i>
                  <h5 class="card-title">หน้าติดต่อ</h5>
                  <p class="card-text text-muted">จัดการข้อมูลติดต่อ</p>
                  <small class="text-info">contact-content.json</small>
                </div>
              </div>
            </div>

            <!-- Other JSON Files -->
            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('navigation')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-bars fa-3x text-info mb-3"></i>
                  <h5 class="card-title">เมนูนำทาง</h5>
                  <p class="card-text text-muted">จัดการเมนูและลิงก์</p>
                  <small class="text-info">navigation.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('footer')"
              >
                <div class="card-body text-center">
                  <i
                    class="fas fa-window-minimize fa-3x text-secondary mb-3"
                  ></i>
                  <h5 class="card-title">Footer</h5>
                  <p class="card-text text-muted">จัดการข้อมูล Footer</p>
                  <small class="text-info">footer.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('site-config')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-cog fa-3x text-primary mb-3"></i>
                  <h5 class="card-title">การตั้งค่าเว็บไซต์</h5>
                  <p class="card-text text-muted">จัดการการตั้งค่าและเมนู</p>
                  <small class="text-info">site-config.json</small>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <div
                class="card json-file-card h-100"
                onclick="loadJsonFile('about-content')"
              >
                <div class="card-body text-center">
                  <i class="fas fa-info-circle fa-3x text-primary mb-3"></i>
                  <h5 class="card-title">เกี่ยวกับเรา</h5>
                  <p class="card-text text-muted">จัดการเนื้อหาเกี่ยวกับเรา</p>
                  <small class="text-info">about-content.json</small>
                </div>
              </div>
            </div>
          </div>

          <!-- JSON Editor Form (Hidden initially) -->
          <div id="jsonEditorForm" style="display: none">
            <div class="card shadow">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>แก้ไขไฟล์:
                    <span id="currentFileName"></span>
                  </h5>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    onclick="backToFileList()"
                  >
                    <i class="fas fa-arrow-left me-1"></i>กลับ
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="dynamicForm">
                  <!-- Dynamic form will be generated here -->
                </div>

                <div class="mt-4 text-center">
                  <button
                    type="button"
                    class="btn btn-save btn-lg me-2"
                    onclick="saveJsonFile()"
                    id="saveButton"
                  >
                    <i class="fas fa-save me-2"></i>บันทึกการเปลี่ยนแปลง
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-warning btn-lg me-2"
                    onclick="resetToOriginal()"
                  >
                    <i class="fas fa-file-import me-2"></i>โหลดต้นฉบับ
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-lg me-2"
                    onclick="resetForm()"
                  >
                    <i class="fas fa-undo me-2"></i>รีเซ็ต
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-info btn-lg me-2"
                    onclick="previewJson()"
                  >
                    <i class="fas fa-eye me-2"></i>ดูตัวอย่าง JSON
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-success btn-lg"
                    onclick="validateJson()"
                  >
                    <i class="fas fa-check-circle me-2"></i>ตรวจสอบ JSON
                  </button>
                </div>

                <!-- Save Status -->
                <div class="mt-3">
                  <div
                    id="saveStatus"
                    class="text-center"
                    style="display: none"
                  >
                    <div
                      class="spinner-border spinner-border-sm text-primary me-2"
                      role="status"
                    >
                      <span class="visually-hidden">กำลังบันทึก...</span>
                    </div>
                    <span class="text-muted">กำลังบันทึกข้อมูล...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JSON Editor JS -->
    <script src="../js/json-editor.js"></script>

    <script>
      // Logout function
      function logout() {
        if (confirm("ต้องการออกจากระบบหรือไม่?")) {
          localStorage.removeItem("adminLoggedIn");
          localStorage.removeItem("adminLoginTime");
          window.location.href = "login.html";
        }
      }

      // API Status functions
      async function checkApiStatus() {
        const statusIcon = document.getElementById("apiStatusIcon");
        const statusText = document.getElementById("apiStatusText");

        try {
          statusIcon.className = "fas fa-circle text-warning";
          statusText.textContent = "กำลังตรวจสอบ...";

          const response = await fetch("/api/json");
          const result = await response.json();

          if (result.success) {
            statusIcon.className = "fas fa-circle text-success";
            statusText.textContent = `เชื่อมต่อสำเร็จ - พบ ${result.files.length} ไฟล์`;
          } else {
            throw new Error("API Error");
          }
        } catch (error) {
          statusIcon.className = "fas fa-circle text-danger";
          statusText.textContent =
            "ไม่สามารถเชื่อมต่อ API ได้ (ใช้โหมด Fallback)";
        }
      }

      // View backups function
      async function viewBackups() {
        try {
          const response = await fetch("/api/backups");
          const result = await response.json();

          if (result.success) {
            showBackupsModal(result.backups);
          } else {
            showAlert("ไม่สามารถโหลดข้อมูล backup ได้", "warning");
          }
        } catch (error) {
          showAlert(
            "เกิดข้อผิดพลาดในการโหลด backup: " + error.message,
            "danger"
          );
        }
      }

      // Show backups modal
      function showBackupsModal(backups) {
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="fas fa-history me-2"></i>ไฟล์ Backup
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${
                  backups.length === 0
                    ? '<p class="text-muted text-center">ไม่มีไฟล์ backup</p>'
                    : `<div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>ไฟล์ต้นฉบับ</th>
                          <th>วันที่สร้าง</th>
                          <th>ขนาด</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${backups
                          .map(
                            (backup) => `
                          <tr>
                            <td>${backup.originalFile}.json</td>
                            <td>${new Date(backup.created).toLocaleString(
                              "th-TH"
                            )}</td>
                            <td>${(backup.size / 1024).toFixed(2)} KB</td>
                          </tr>
                        `
                          )
                          .join("")}
                      </tbody>
                    </table>
                  </div>`
                }
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        modal.addEventListener("hidden.bs.modal", () => {
          document.body.removeChild(modal);
        });
      }

      // Validate JSON function
      function validateJson() {
        try {
          const formData = collectFormData();
          const jsonString = JSON.stringify(formData, null, 2);

          // Try to parse it back to validate
          JSON.parse(jsonString);

          showAlert("JSON ถูกต้อง ✅", "success");
        } catch (error) {
          showAlert("JSON ไม่ถูกต้อง: " + error.message, "danger");
        }
      }

      // Enhanced save button with loading state
      function setSaveButtonLoading(loading) {
        const saveButton = document.getElementById("saveButton");
        const saveStatus = document.getElementById("saveStatus");

        if (loading) {
          saveButton.disabled = true;
          saveButton.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
          saveStatus.style.display = "block";
        } else {
          saveButton.disabled = false;
          saveButton.innerHTML =
            '<i class="fas fa-save me-2"></i>บันทึกการเปลี่ยนแปลง';
          saveStatus.style.display = "none";
        }
      }

      // Mobile navigation functions
      function toggleMobileNav() {
        const sidebar = document.getElementById("adminSidebar");
        const overlay = document.querySelector(".mobile-nav-overlay");

        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
      }

      function closeMobileNav() {
        const sidebar = document.getElementById("adminSidebar");
        const overlay = document.querySelector(".mobile-nav-overlay");

        sidebar.classList.remove("show");
        overlay.classList.remove("show");
      }

      // Close mobile nav when clicking on nav links
      document.addEventListener("click", function (e) {
        if (e.target.closest(".admin-sidebar .nav-link")) {
          closeMobileNav();
        }
      });

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", function () {
        const isLoggedIn = localStorage.getItem("adminLoggedIn");
        if (isLoggedIn !== "true") {
          window.location.href = "login.html";
          return;
        }

        // Check session timeout (24 hours)
        const loginTime = localStorage.getItem("adminLoginTime");
        if (loginTime) {
          const now = new Date();
          const login = new Date(loginTime);
          const hoursDiff = (now - login) / (1000 * 60 * 60);

          if (hoursDiff > 24) {
            alert("เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่");
            logout();
            return;
          }
        }

        // Check API status on load
        checkApiStatus();
      });
    </script>
  </body>
</html>
